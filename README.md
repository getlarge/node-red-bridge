# Node-red-bridge

Node-RED running as local user, served by Express.

- Contains subflows to quickly connect to Aloes API, [device-manager](https://framagit.org/aloes/device-manager.git)

- Custom authentification schemes, using Aloes backend.

- Edit scenarios to create interactions chains with your devices.

## Settings

NODE_RED_USERNAME : used for dashboard HTTP basic auth ( optional )
NODE_RED_USERPASS : used for dashboard HTTP basic auth ( optional )
NODE_RED_HTTP_AUTH : false/true, used to activate dashboard HTTP basic auth
NODE_RED_CREDENTIAL_SECRET : used to save node-red flow credentials ( optional )
NODE_RED_SESSION_SECRET : used for express session
NODE_RED_STORE_TYPE : used to select default storage method ( can be "memoryOnly" or "file" )
ALOES_HTTP_HOST : Aloes HTTP server host
ALOES_HTTP_PORT : Aloes HTTP server port
ALOES_HTTP_SECURE : false/true Aloes HTTP/HTTPS
ALOES_MQTT_HOST : Aloes MQTT / WS server host or url
ALOES_MQTT_PORT : Aloes MQTT / WS server port
ALOES_MQTT_SECURE : false/true Aloes MQTT/MQTTS
ALOES_USER_ID : userId generated by Aloes
ALOES_USER_EMAIL : username to log on Node-red admin interface ( use the same as aloes )
ALOES_USER_PASSWORD : password to log on Node-red admin interface ( use the same as aloes )
ALOES_TOKEN : automatically generated after login
ALOES_TOPIC_IN : Used to receive aloes events \${ALOES_USER_ID}/#

### Required :

- Use settings.js for Node-red standalone start ( with Node-red commands ).
- Use `lib/node-setup.js` and `deploy/` when embedding in Express application.

### Optionals :

- If you don't have any device yet, you can setup your own with [Aloes device](https://framagit.org/aloes/arduino-device-mqtt) for Arduino, or [node-red-device](https://framagit.org/getlarge/node-red-device.git) for any Linux device.

- Register a new device with [Aloes Client](https://framagit.org/aloes/aloes-client.git)

- To generate a new password, use this command :

```bash
node -e "console.log(require('bcryptjs').hashSync(process.argv[1], 8));" your-password-here
```

And copy generated password into settings.js, or deploy/.env files coresponding to your NODE_ENV.

## Usage

```bash
git clone https://framagit.org/aloes/node-red-bridge.git
npm install
```

### Starting with Node-red CLI

When running multiple instances in parallel, you can specify a port:

```bash
npm run start -- -p 1885
```

To run a specific flow file:

```bash
npm run start -- testFlow.json
```

### Starting with Nodemon

To run via Express ( create .env file first using .env.sample as model ):

```bash
npm run start:local
```

### Starting with PM2

```bash
npm install -g pm2
```

Create deploy/.env\_ files coresponding to your NODE_ENV. ( .env_local for NODE_ENV=local ).

Edit ecosystem.config.js, then

```bash
npm run deploy:local
```

If you want to autorestart node-red

```bash
pm2 startup
pm2 save
```
